<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ìƒí’ˆ ê´€ë¦¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');

        :root {
            --brand-primary: #28a745;
            --brand-primary-dark: #218838;
            --brand-bg: #F8F9FA;
            --brand-surface: #FFFFFF;
            --brand-border: #DEE2E6;
            --text-primary: #212529;
            --text-secondary: #6C757D;
            --text-error: #DC3545;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --primary-color: var(--brand-primary);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        body { background-color: var(--brand-bg); color: var(--text-primary); line-height: 1.6; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: var(--brand-surface); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); border-radius: 12px; margin: 20px 40px 0 40px; border-bottom: 2px solid var(--brand-border); padding-bottom: 15px; margin-bottom: 25px; }
        .header-links { display: flex; align-items: center; gap: 15px; }
        .logo { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .shop-link { text-decoration: none; color: var(--text-secondary); padding: 8px 15px; border: 1px solid var(--brand-border); border-radius: 5px; transition: all 0.3s ease; }
        .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 30px 40px; background: var(--brand-surface); border-radius: 12px; box-shadow: var(--shadow); }
        .summary-cards { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 30px; }
        .card { flex: 1; display: flex; flex-direction: column; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); min-height: 100px; background-color: #f1f3f5; border-left: 5px solid var(--primary-color); }
        .card .label { font-size: 14px; color: var(--text-secondary); }
        .card .value { font-size: 24px; font-weight: bold; }
        h2 { color: var(--primary-color); font-size: 22px; margin-bottom: 15px; }
        .btn-primary, .btn-secondary { padding: 10px 15px; border-radius: 25px; cursor: pointer; font-size: 14px; border: none; transition: background-color 0.2s; margin-right: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-small { padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-left: 5px; }
        .btn-edit { background-color: #868686; color: white; }
        .btn-delete { background-color: var(--text-error); color: white; border: none; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; table-layout: fixed; }
        .data-table th, .data-table td { border: 1px solid var(--brand-border); padding: 12px; text-align: left; }
        .data-table th { background-color: #f1f3f5; font-weight: 600; color: #343a40; text-align: center; }
        .data-table tbody tr:hover { background-color: var(--brand-border); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--brand-surface); margin: 8% auto; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 550px; }
        .close-button { float: right; font-size: 30px; font-weight: bold; cursor: pointer; }
        .modal-content input[type="text"], .modal-content input[type="number"] { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border: 1px solid var(--brand-border); border-radius: 8px; box-sizing: border-box; }
        .modal-content button { width: 100%; margin-top: 15px; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <header class="header">
        <h1 class="logo">ğŸŒ¿ FARM ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
        <div class="header-links">
            <span id="admin-greeting">ìƒí’ˆ ê´€ë¦¬ìë‹˜</span>
            <a href="#" id="logout-btn" class="shop-link">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </header>

    <section class="summary-cards">
        <div class="card sale-card"><span class="label">ì´ ë§¤ì¶œ</span><span class="value" id="summary-total-sales">0ì›</span><i class="icon">ğŸ’°</i></div>
        <div class="card order-card"><span class="label">ì´ ì£¼ë¬¸</span><span class="value" id="summary-total-orders">0ê±´</span><i class="icon">ğŸ“¦</i></div>
        <div class="card item-card"><span class="label">ë“±ë¡ ìƒí’ˆ</span><span class="value" id="summary-total-items">0ê°œ</span><i class="icon">ğŸ“ˆ</i></div>
        <div class="card avg-order-card"><span class="label">í‰ê·  ì£¼ë¬¸ì•¡</span><span class="value" id="summary-avg-order">0ì›</span><i class="icon">ğŸ“Š</i></div>
    </section>

    <div class="main-content active" id="product-manage">
        <h2>ìƒí’ˆ ëª©ë¡</h2>
        <button class="btn-primary" onclick="openModal('new-product-modal')">+ ìƒˆ ìƒí’ˆ ë“±ë¡</button>

        <table class="data-table product-table">
            <thead>
            <tr>
                <th>ìƒí’ˆ ID</th>
                <th>ìƒí’ˆëª…</th>
                <th>ê°€ê²©</th>
                <th>ì €ì¥í’ˆëª©ID</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody id="product-list">
            <tr><td colspan="5">ìƒí’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="new-product-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('new-product-modal')">&times;</span>
        <h3>ìƒˆ ìƒí’ˆ ë“±ë¡</h3>
        <form id="new-product-form">
            <label>ìƒí’ˆëª…</label><input type="text" id="new-item-name" placeholder="ì˜ˆ: ìœ ê¸°ë† í† ë§ˆí† " required>
            <label>ê°€ê²©</label><input type="number" id="new-item-price" placeholder="ì˜ˆ: 12000" required>
            <label>ì €ì¥í’ˆëª©ID</label><input type="text" id="new-stor-id" placeholder="ì˜ˆ: 101" required>
            <button type="submit" class="btn-primary">ë“±ë¡í•˜ê¸°</button>
        </form>
    </div>
</div>

<div id="edit-product-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('edit-product-modal')">&times;</span>
        <h3>ìƒí’ˆ ìˆ˜ì • (ID: <span id="edit-product-id-display"></span>)</h3>
        <form id="edit-product-form">
            <input type="hidden" id="edit-item-id">
            <label>ìƒí’ˆëª…</label><input type="text" id="edit-item-name" placeholder="ì˜ˆ: ìœ ê¸°ë† í† ë§ˆí† ">
            <label>ê°€ê²©</label><input type="number" id="edit-item-price" placeholder="ì˜ˆ: 12000">
            <label>ì €ì¥í’ˆëª©ID</label><input type="text" id="edit-stor-id" placeholder="ì˜ˆ: 101">
            <button type="submit" class="btn-primary">ìˆ˜ì • ì™„ë£Œ</button>
        </form>
    </div>
</div>

<script>
    const API_BASE_URL = '/admin/shop'; // ShopControllerì˜ @RequestMapping("/shop")ê³¼ ì¼ì¹˜

    document.addEventListener('DOMContentLoaded', () => {
        renderProductList();
        renderStatistics();
        document.getElementById('new-product-form')?.addEventListener('submit', handleNewProduct);
        document.getElementById('edit-product-form')?.addEventListener('submit', handleEditProduct);
    });

    // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° í•¨ìˆ˜
    function openModal(modalId, itemId = null) {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        const modal = document.getElementById(modalId);
        if (modal) {
            if (modalId === 'edit-product-modal' && itemId) {
                document.getElementById('edit-product-id-display').textContent = itemId;
                document.getElementById('edit-item-id').value = itemId;
                populateEditForm(itemId);
            }
            modal.style.display = 'block';
        }
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal ? modal.style.display = 'none' : null;
    }

    // ìƒí’ˆ ì¡°íšŒ ë° ë Œë”ë§ (GET /shop)
    async function renderProductList() {
        const list = document.getElementById('product-list');
        list.innerHTML = '<tr><td colspan="5">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

        try {
            const response = await fetch(API_BASE_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const products = await response.json();

            if (products.length === 0) {
                list.innerHTML = '<tr><td colspan="5">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                document.getElementById('summary-total-items').textContent = '0ê°œ';
                return;
            }

            list.innerHTML = products.map(product => `
                    <tr data-id="${product.itemId}">
                        <td>${product.itemId}</td>
                        <td>${product.itemName}</td>
                        <td>${product.price ? product.price.toLocaleString() + 'ì›' : 'N/A'}</td>
                        <td>${product.storId || 'N/A'}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="openModal('edit-product-modal', ${product.itemId})">ìˆ˜ì •</button>
                            <button class="btn-small btn-delete" onclick="handleDeleteProduct(${product.itemId})">ì‚­ì œ</button>
                        </td>
                    </tr>
                `).join('');

            document.getElementById('summary-total-items').textContent = products.length + 'ê°œ';

        } catch (error) {
            console.error('ìƒí’ˆ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', error);
            list.innerHTML = '<tr><td colspan="5">ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.</td></tr>';
        }
    }

    // ìƒí’ˆ ë“±ë¡ (POST /shop/additem)
    async function handleNewProduct(e) {
        e.preventDefault();

        const itemName = document.getElementById('new-item-name').value;
        const priceInput = document.getElementById('new-item-price').value;
        const storId = document.getElementById('new-stor-id').value;

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!validateForm(itemName, parseInt(priceInput), storId)) {
            return; // ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
        }

        const itemVO = {
            itemName: document.getElementById('new-item-name').value,
            price: parseInt(document.getElementById('new-item-price').value || 0),
            storId: document.getElementById('new-stor-id').value
        };

        try {
            const response = await fetch(API_BASE_URL + '/additem', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemVO)
            });

            if (response.status === 201) {
                alert(`ìƒí’ˆ '${itemVO.itemName}' ë“±ë¡ ì™„ë£Œ!`);
                closeModal('new-product-modal');
                document.getElementById('new-product-form').reset();
                renderProductList();
            } else {
                alert('ìƒí’ˆ ë“±ë¡ ì‹¤íŒ¨! ì„œë²„ ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.');
            }

        } catch (error) {
            console.error('ë“±ë¡ í†µì‹  ì˜¤ë¥˜:', error);
            alert('ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ìˆ˜ì • ëª¨ë‹¬ì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
    async function populateEditForm(itemId) {
        try {
            // ìˆ˜ì •: ìƒì„¸ì¡°íšŒ ì „ìš© API í˜¸ì¶œ
            const response = await fetch(API_BASE_URL + '/item/' + itemId); // GET /admin/shop/item/{itemId}

            if (!response.ok) throw new Error('ìƒì„¸ ìƒí’ˆ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            const item = await response.json(); // íŠ¹ì • ìƒí’ˆ ê°ì²´ í•˜ë‚˜ë§Œ ë°˜í™˜

            document.getElementById('edit-item-name').value = item.itemName || '';
            document.getElementById('edit-item-price').value = item.price || 0;
            document.getElementById('edit-stor-id').value = item.storId || '';

        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            alert('ìˆ˜ì •í•  ìƒí’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ìƒí’ˆ ìˆ˜ì • (PUT /shop/item/{id})
    async function handleEditProduct(e) {
        e.preventDefault();

        const itemId = document.getElementById('edit-item-id').value;

        const itemName = document.getElementById('new-item-name').value;
        const priceInput = document.getElementById('new-item-price').value;
        const storId = document.getElementById('new-stor-id').value;

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!validateForm(itemName, parseInt(priceInput), storId, true)) {
            return; // ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
        }

        const itemVO = {
            itemName: document.getElementById('edit-item-name').value,
            price: parseInt(document.getElementById('edit-item-price').value || 0),
            storId: document.getElementById('edit-stor-id').value
        };

        try {
            const response = await fetch(API_BASE_URL + '/item/' + itemId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemVO)
            });

            if (response.ok) { // 200 OK
                alert(`ìƒí’ˆ ID ${itemId} ì •ë³´ ìˆ˜ì • ì™„ë£Œ!`);
                closeModal('edit-product-modal');
                renderProductList();
            } else {
                alert('ìƒí’ˆ ìˆ˜ì • ì‹¤íŒ¨! ì„œë²„ ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.');
            }

        } catch (error) {
            console.error('ìˆ˜ì • í†µì‹  ì˜¤ë¥˜:', error);
            alert('ìƒí’ˆ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ìƒí’ˆ ì‚­ì œ (DELETE /shop/item/{id})
    async function handleDeleteProduct(itemId) {
        if (!confirm(`ìƒí’ˆ ID: ${itemId}ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        try {
            const response = await fetch(API_BASE_URL + '/item/' + itemId, {
                method: 'DELETE'
            });

            if (response.status === 204) { // 204 No Content
                alert(`ìƒí’ˆ ID: ${itemId} ì‚­ì œ ì™„ë£Œ.`);
                renderProductList();
            } else {
                alert('ìƒí’ˆ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì˜¤ë¥˜)');
            }

        } catch (error) {
            console.error('ì‚­ì œ í†µì‹  ì˜¤ë¥˜:', error);
            alert('ìƒí’ˆ ì‚­ì œ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // í†µê³„ ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜ (GET /admin/shop/stats)
    async function renderStatistics() {
        const STAT_API_URL = API_BASE_URL + '/stats';

        try {
            const response = await fetch(STAT_API_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const stats = await response.json(); // StatVO ê°ì²´ë¥¼ ë°›ìŒ

            // 1. ì´ ë§¤ì¶œ
            document.getElementById('summary-total-sales').textContent =
                (stats.totalSales || 0).toLocaleString() + 'ì›';

            // 2. ì´ ì£¼ë¬¸
            document.getElementById('summary-total-orders').textContent =
                (stats.totalOrders || 0).toLocaleString() + 'ê±´';

            // 3. ë“±ë¡ ìƒí’ˆ (renderProductListì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆìœ¼ë‚˜, StatVOì—ë„ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸)
            // ë§Œì•½ ìƒí’ˆ ê°œìˆ˜ë§Œ ì—¬ê¸°ì„œ ì²˜ë¦¬í•œë‹¤ë©´:
            document.getElementById('summary-total-items').textContent =
                (stats.totalItems || 0).toLocaleString() + 'ê°œ';

            // 4. í‰ê·  ì£¼ë¬¸ì•¡
            document.getElementById('summary-avg-order').textContent =
                (stats.avgOrderAmount || 0).toLocaleString() + 'ì›';

        } catch (error) {
            console.error('í†µê³„ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ 0ìœ¼ë¡œ í‘œì‹œ ìœ ì§€
        }
    }

    // ìœ íš¨ì„± ê²€ì‚¬
    function validateForm(itemName, price, storId, isUpdate = false) {
        if (!itemName || itemName.trim() === "") {
            alert("ìƒí’ˆëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return false;
        }

        if (!price || isNaN(price) || price < 0) {
            alert("ê°€ê²©ì„ ì •í™•í•œ ìˆ«ì(0 ì´ìƒ)ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return false;
        }

        // ì €ì¥í’ˆëª©ID (storId)ëŠ” ë¬¸ìì—´ì´ í—ˆìš©ë˜ë¯€ë¡œ í•„ìˆ˜ ì…ë ¥ë§Œ ê²€ì‚¬
        if (!storId || storId.trim() === "") {
            alert("ì €ì¥í’ˆëª©IDë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return false;
        }

        return true;
    }

</script>
</body>
</html>