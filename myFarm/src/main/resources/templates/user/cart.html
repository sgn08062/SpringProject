<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì¥ë°”êµ¬ë‹ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/main/main.css}">
    <link rel="stylesheet" th:href="@{/css/cart.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="light">

<header>
    <div class="header-container">
    </div>
</header>

<div class="cart-container">
    <h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>

    <div th:if="${successMessage}" class="message success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="message error" th:text="${errorMessage}"></div>

    <div th:if="${cartList == null or cartList.empty}">
        <p style="text-align: center; margin-top: 50px; font-size: 1.1em;">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ìƒí’ˆ ëª©ë¡ì—ì„œ ì›í•˜ëŠ” ìƒí’ˆì„ ë‹´ì•„ë³´ì„¸ìš”!</p>
    </div>

    <form th:action="@{/user/order}" method="get" id="checkoutForm">
        <div th:each="item : ${cartList}" class="cart-item" th:id="|cart-item-${item.itemId}|">

            <input type="checkbox" name="selectedItems" th:value="${item.itemId}" checked>

            <div class="item-details">
                <div class="item-name" th:text="${item.itemName}">ìœ ê¸°ë† ê°ì</div>
                <div class="item-price" th:text="|ë‹¨ê°€: ${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}ì›|">ë‹¨ê°€: 5,000ì›</div>
                <div class="item-stock" th:text="|ì¬ê³ : ${item.stockAmount} ê°œ|">ì¬ê³ : 50 ê°œ</div>
            </div>

            <div class="item-quantity">
                <input type="number"
                       th:name="|itemAmount_${item.itemId}|"
                       th:id="|amount-${item.itemId}|"
                       th:value="${item.amount}"
                       min="1"
                       th:max="${item.stockAmount}"
                       onchange="updateItemAmount(this.id, this.value)"
                       style="width: 60px;">
                <span>ê°œ</span>
            </div>

            <div class="item-total" th:id="|total-${item.itemId}|">
                <span th:text="${#numbers.formatDecimal(item.price * item.amount, 0, 'COMMA', 0, 'POINT') + 'ì›'}">10,000ì›</span>
            </div>

            <div class="item-actions">
                <button type="button" th:onclick="|deleteCartItem(${item.itemId})|">ì‚­ì œ</button>
            </div>
        </div>

        <div th:if="${not (cartList == null or cartList.empty)}" class="total-summary">
            <span id="grandTotalText">ì´ ê²°ì œ ê¸ˆì•¡: </span>
            <span id="grandTotal">0ì›</span>
        </div>

        <div th:if="${not (cartList == null or cartList.empty)}" class="checkout-button">
            <a href="/user/list" class="main-return-button">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            <button type="submit">ì„ íƒ ìƒí’ˆ ì£¼ë¬¸í•˜ê¸°</button>
        </div>
    </form>
</div>

<script th:inline="javascript">
    const cartItems = [[${cartList}]];
    const updateUrl = [[@{/user/cart/update}]];
    const deleteUrl = [[@{/user/cart/delete}]];

    function updateItemAmount(amountInputId, newAmount) {
        // amountInputIdëŠ” "amount-101" í˜•íƒœ
        const itemId = amountInputId.split('-')[1];
        const item = cartItems.find(i => i.itemId == itemId);

        if (!item || newAmount < 1) return;

        if (newAmount > item.stockAmount) {
            alert("ì¬ê³  ìˆ˜ëŸ‰(" + item.stockAmount + "ê°œ)ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            $('#' + amountInputId).val(item.stockAmount);
            newAmount = item.stockAmount;
        }

        $.ajax({
            url: updateUrl,
            type: 'POST',
            data: { itemId: itemId, amount: newAmount },
            success: function(response) {
                if (response.success) {
                    item.amount = parseInt(newAmount);

                    const newTotal = item.price * item.amount;
                    $(`#total-${itemId}`).text(newTotal.toLocaleString('ko-KR') + 'ì›');

                    calculateGrandTotal();
                } else {
                    alert("ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨: " + response.message);
                }
            },
            error: function() {
                alert("ìˆ˜ëŸ‰ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                $('#' + amountInputId).val(item.amount);
            }
        });
    }

    function deleteCartItem(itemId) {
        if (!confirm("í•´ë‹¹ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
        }

        // Controllerì˜ POST /user/cart/delete/{itemId} ê²½ë¡œì— ë§ì¶¤
        $.ajax({
            url: `${deleteUrl}/${itemId}`,
            type: 'POST',
            success: function() {
                $(`#cart-item-${itemId}`).remove();

                const index = cartItems.findIndex(i => i.itemId == itemId);
                if (index > -1) {
                    cartItems.splice(index, 1);
                }

                calculateGrandTotal();
                if (cartItems.length === 0) {
                    // ì¥ë°”êµ¬ë‹ˆê°€ ì™„ì „íˆ ë¹„ì—ˆì„ ë•Œ í™”ë©´ì„ ì—…ë°ì´íŠ¸
                    $('.cart-container').html('<h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2><p style="text-align: center; margin-top: 50px; font-size: 1.1em;">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ìƒí’ˆ ëª©ë¡ì—ì„œ ì›í•˜ëŠ” ìƒí’ˆì„ ë‹´ì•„ë³´ì„¸ìš”!</p>');
                }
            },
            error: function() {
                alert("ì¥ë°”êµ¬ë‹ˆ í•­ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    function calculateGrandTotal() {
        let total = 0;

        $('.cart-item').each(function() {
            const checkbox = $(this).find('input[name="selectedItems"]');
            if (checkbox.is(':checked')) {
                const itemId = checkbox.val();
                // amount í•„ë“œì˜ IDë¥¼ ì‚¬ìš©
                const amount = parseInt($(`#amount-${itemId}`).val());
                const item = cartItems.find(i => i.itemId == itemId);

                if (item) {
                    total += item.price * amount;
                }
            }
        });

        $('#grandTotal').text(total.toLocaleString('ko-KR') + 'ì›');
    }

    $(document).ready(function() {
        calculateGrandTotal();

        // ì„ íƒ ìƒí’ˆ ë³€ê²½ ì‹œ ì´ì•¡ ì¬ê³„ì‚°
        $('input[name="selectedItems"]').on('change', calculateGrandTotal);
    });

    $('#checkoutForm').on('submit', function(e) {
        const checkedItems = $('input[name="selectedItems"]:checked');
        if (checkedItems.length === 0) {
            e.preventDefault();
            alert("ì£¼ë¬¸í•  ìƒí’ˆì„ 1ê°œ ì´ìƒ ì„ íƒí•´ ì£¼ì„¸ìš”.");
            return;
        }

        // ğŸ’¡ ìˆ˜ì •ëœ í•µì‹¬ ë¡œì§:
        // 1. ëª¨ë“  ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œë¥¼ í™œì„±í™” ìƒíƒœë¡œ ë³µêµ¬ (ì´ì „ ì œì¶œ ì‹œ disabledëœ ê²½ìš°ë¥¼ ëŒ€ë¹„)
        $('input[name^="itemAmount_"]').prop('disabled', false);

        // 2. ì„ íƒë˜ì§€ ì•Šì€ ìƒí’ˆì˜ ìˆ˜ëŸ‰ í•„ë“œëŠ” ë¹„í™œì„±í™”í•˜ì—¬ ì „ì†¡í•˜ì§€ ì•ŠìŒ
        $('input[name^="itemAmount_"]').each(function() {
            // ìˆ˜ëŸ‰ í•„ë“œì˜ IDì—ì„œ itemId ì¶”ì¶œ
            const itemId = $(this).attr('id').split('-')[1];
            const checkbox = $(`#cart-item-${itemId}`).find('input[name="selectedItems"]');

            if (!checkbox.is(':checked')) {
                // ì²´í¬ë˜ì§€ ì•Šì•˜ë‹¤ë©´ í•´ë‹¹ ìˆ˜ëŸ‰ í•„ë“œë¥¼ ë¹„í™œì„±í™”í•˜ì—¬ í¼ ì „ì†¡ ì‹œ ì œì™¸
                $(this).prop('disabled', true);
            }
        });

        // í¼ì´ ì œì¶œë©ë‹ˆë‹¤. (selectedItems=1&selectedItems=3&itemAmount_1=5&itemAmount_3=2 ì™€ ê°™ì€ í˜•íƒœë¡œ ì „ì†¡)
        return true;
    });
</script>
</body>
</html>