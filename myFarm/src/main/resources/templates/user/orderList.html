<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
</head>
<body>
<h1>ğŸ›’ ì£¼ë¬¸/ê²°ì œ</h1>

<form th:action="@{/user/placeOrder}" method="post" id="orderForm">

    <div th:if="${defaultAddress != null}">
        <input type="hidden" name="addressId" th:value="${defaultAddress.addId}" id="defaultAddressId">
    </div>

    <div style="margin-bottom: 15px;">
        <label>
            <input type="radio" name="addressOption" value="default" checked> ê¸°ë³¸ ë°°ì†¡ì§€ ì‚¬ìš©

            <span th:if="${defaultAddress != null}"
                  th:text="${defaultAddress.address + ' (' + defaultAddress.addName + ') / ' + defaultAddress.phone}">
                ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ (ê¹€ì² ìˆ˜) / 010-1234-5678
            </span>
            <span th:if="${defaultAddress == null}">ê¸°ë³¸ ë°°ì†¡ì§€ ì •ë³´ ì—†ìŒ</span>
        </label><br>

        <label>
            <input type="radio" name="addressOption" value="new"> ìƒˆë¡œìš´ ë°°ì†¡ì§€ ì…ë ¥
            <a th:href="@{/user/orders?tab=address}" target="_blank" style="margin-left: 10px;">(ì£¼ì†Œ ê´€ë¦¬)</a>
        </label>
    </div>

    <div id="newAddressFields" style="display: none;">
        <p>
            <label for="newAddressName">ë°°ì†¡ì§€ëª…:</label>
            <input type="text" id="newAddressName" name="newAddressName" placeholder="(ì˜ˆ: ìš°ë¦¬ì§‘, íšŒì‚¬)">
        </p>
        <p>
            <label for="newAddress">ì£¼ì†Œ:</label>
            <input type="text" id="newAddress" name="newAddress" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ í¬í•¨í•˜ì—¬ ì…ë ¥">
        </p>
        <p>
            <label for="newPhone">ì—°ë½ì²˜:</label>
            <input type="text" id="newPhone" name="newPhone" placeholder="010-XXXX-XXXX">
        </p>
    </div>

    <hr>
    <hr>

    <h2>ìµœì¢… ê²°ì œ ê¸ˆì•¡: <span id="finalTotal" th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">20,000ì›</span></h2>

    <button type="submit">ê²°ì œí•˜ê¸° (ì£¼ë¬¸ í™•ì •)</button>

</form>

<script>
    $(document).ready(function() {
        const $newFields = $('#newAddressFields');
        const $newInputs = $newFields.find('input');
        const $addressIdInput = $('#defaultAddressId');

        function toggleAddressInputs(isNew) {
            if (isNew) {
                $newFields.show();
                // ìƒˆ ì£¼ì†Œ ì…ë ¥ í•„ë“œë¥¼ í•„ìˆ˜ë¡œ ì„¤ì •
                $newInputs.prop('required', true);
                // ê¸°ë³¸ ì£¼ì†Œ IDë¥¼ ì „ì†¡í•˜ì§€ ì•Šë„ë¡ ë¹„í™œì„±í™”
                $addressIdInput.prop('name', 'addressId_disabled').prop('disabled', true);

            } else {
                $newFields.hide();
                // ìƒˆ ì£¼ì†Œ ì…ë ¥ í•„ë“œì˜ í•„ìˆ˜ ë° nameì„ í•´ì œ
                $newInputs.prop('required', false).prop('name', function() {
                    return $(this).attr('id'); // name ì†ì„±ì„ idë¡œ ë³µêµ¬ (ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•Šë„ë¡)
                });

                // ê¸°ë³¸ ì£¼ì†Œ IDë¥¼ ì „ì†¡í•˜ë„ë¡ í™œì„±í™” (Controllerì˜ @RequestParam Long addressId íŒŒë¼ë¯¸í„°ë¡œ ì „ì†¡)
                $addressIdInput.prop('name', 'addressId').prop('disabled', false);
            }
        }

        // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ì´ë²¤íŠ¸ ì²˜ë¦¬
        $('input[name="addressOption"]').on('change', function() {
            toggleAddressInputs($(this).val() === 'new');
        });

        // ì´ˆê¸° ë¡œë“œ ì‹œ ìƒíƒœ ì„¤ì •
        toggleAddressInputs($('input[name="addressOption"]:checked').val() === 'new');

        // í¼ ì œì¶œ ì‹œ ìœ íš¨ì„± ê²€ì‚¬ (ìƒˆ ì£¼ì†Œ ì„ íƒ ì‹œ addressIdê°€ ë¹„í™œì„±í™”ëœ ì±„ ì „ì†¡ë¨)
        $('#orderForm').on('submit', function(e) {
            if ($('input[name="addressOption"]:checked').val() === 'default' && !$addressIdInput.val()) {
                e.preventDefault();
                alert("ê¸°ë³¸ ë°°ì†¡ì§€ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë°°ì†¡ì§€ ê´€ë¦¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                return;
            }
            // ìƒˆ ì£¼ì†Œ ì„ íƒ ì‹œ, required ì†ì„±ì´ trueì´ë¯€ë¡œ ë¸Œë¼ìš°ì € ìì²´ ìœ íš¨ì„± ê²€ì‚¬ë¡œ ì²˜ë¦¬ë¨.
        });
    });
</script>
</body>
</html>