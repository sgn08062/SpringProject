<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ë¬¸/ê²°ì œ</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/order.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        /* CSSëŠ” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; text-align: center; }
        th, td { border: 1px solid #ddd; padding: 10px; }
        th { background-color: #f2f2f2; }
        td:nth-child(2), td:nth-child(4) { text-align: right; }
        h2 { margin-top: 20px; }
        #finalTotal { font-size: 1.5em; color: #dc3545; font-weight: bold; }
        button[type="submit"] { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; margin-top: 20px; }

        /* ìƒˆë¡œ ì¶”ê°€ëœ ì£¼ì†Œ UI ìŠ¤íƒ€ì¼ */
        .address-option label { display: block; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; cursor: pointer; border-radius: 4px; }
        .address-option input[type="radio"]:checked + label { border-color: #28a745; background-color: #e9ffe9; font-weight: bold; }
        .address-detail-text { margin-left: 20px; font-size: 0.9em; color: #555; }

        /* ìƒˆë¡œìš´ ì£¼ì†Œ ëª©ë¡ ì„¹ì…˜ ì¶”ê°€ */
        .other-address-list { border: 1px solid #eee; padding: 10px; margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .other-address-list .address-option label { border: none; border-bottom: 1px dashed #ddd; margin-bottom: 0; }
        .other-address-list .address-option:last-child label { border-bottom: none; }
    </style>
</head>
<body>
<h1>ğŸ›’ ì£¼ë¬¸/ê²°ì œ</h1>

<div th:if="${successMessage}" class="message success" th:text="${successMessage}"></div>
<div th:if="${errorMessage}" class="message error" th:text="${errorMessage}"></div>

<form th:action="@{/user/placeOrder}" method="post" id="orderForm">

    <input type="hidden" name="addressId" id="addressId" th:value="${defaultAddress != null ? defaultAddress.addressId : ''}">
    <input type="hidden" name="recipientName" id="recipientName" th:value="${defaultAddress != null ? defaultAddress.recipientName : ''}">
    <input type="hidden" name="phone" id="phone" th:value="${defaultAddress != null ? defaultAddress.recipientPhone : ''}">
    <input type="hidden" name="address" id="address" th:value="${defaultAddress != null ? defaultAddress.address : ''}">
    <input type="hidden" name="addressName" id="addressName" th:value="${defaultAddress != null ? defaultAddress.addressName : ''}">

    <h2>ë°°ì†¡ ì •ë³´</h2>

    <div class="address-options">

        <div th:if="${defaultAddress != null}" class="address-option">
            <input type="radio" id="addr_default" name="addressOption" th:value="${defaultAddress.addressId}"
                   th:data-recipient-name="${defaultAddress.recipientName}" th:data-phone="${defaultAddress.recipientPhone}"
                   th:data-address="${defaultAddress.address}" th:data-address-name="${defaultAddress.addressName}" th:checked="true">
            <label for="addr_default">
                **ê¸°ë³¸ ë°°ì†¡ì§€:** [[${defaultAddress.addressName}]]
                <span class="address-detail-text">([[${defaultAddress.address}]])</span>
                <p style="font-size: 0.8em; margin: 5px 0 0 0;">ìˆ˜ë ¹ì¸: [[${defaultAddress.recipientName}]] / [[${defaultAddress.recipientPhone}]]</p>
            </label>
        </div>

        <div th:if="${otherAddresses != null and otherAddresses.size() > 0}">
            <p style="margin-top: 15px; font-weight: bold;">ğŸ“¦ ê¸°íƒ€ ì €ì¥ëœ ì£¼ì†Œ</p>
            <div class="other-address-list">
                <div th:each="addr : ${otherAddresses}" class="address-option">
                    <input type="radio" th:id="'addr_' + ${addr.addressId}" name="addressOption" th:value="${addr.addressId}"
                           th:data-recipient-name="${addr.recipientName}" th:data-phone="${addr.recipientPhone}"
                           th:data-address="${addr.address}" th:data-address-name="${addr.addressName}">
                    <label th:for="'addr_' + ${addr.addressId}">
                        [[${addr.addressName}]]
                        <span class="address-detail-text">([[${addr.address}]])</span>
                        <p style="font-size: 0.8em; margin: 5px 0 0 0;">ìˆ˜ë ¹ì¸: [[${addr.recipientName}]] / [[${addr.recipientPhone}]]</p>
                    </label>
                </div>
            </div>
        </div>

    </div>

    <hr>

    <h2>ì£¼ë¬¸ ìƒí’ˆ ëª©ë¡</h2>
    <table>
        <thead>
        <tr>
            <th>ìƒí’ˆëª…</th>
            <th>ë‹¨ê°€</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>í•©ê³„</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${checkoutItems}">
            <input type="hidden" th:name="'itemAmount_' + ${item.itemId}" th:value="${item.orderAmount}">
            <input type="hidden" name="selectedItems" th:value="${item.itemId}">

            <td th:text="${item.itemName}">ìƒí’ˆëª…</td>
            <td style="text-align: right;" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + 'ì›'">ë‹¨ê°€</td>
            <td th:text="${item.orderAmount}">ìˆ˜ëŸ‰</td>
            <td style="text-align: right;" th:with="total=${item.orderAmount * item.price}" th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + 'ì›'">í•©ê³„</td>
        </tr>
        </tbody>
    </table>
    <hr>

    <h2>ìµœì¢… ê²°ì œ ê¸ˆì•¡: <span id="finalTotal" th:with="displayPrice=${totalPrice != null ? totalPrice : 0}" th:text="${#numbers.formatDecimal(displayPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">ì´ ê°€ê²©</span></h2>

    <button type="submit">ê²°ì œí•˜ê¸° (ì£¼ë¬¸ í™•ì •)</button>

</form>

<script th:inline="javascript">
    const defaultAddress = /*[[${defaultAddress}]]*/ null;

    $(document).ready(function() {

        // OrderVOì— í•„ìš”í•œ ìˆ¨ê²¨ì§„ í•„ë“œ (ìµœì¢…ì ìœ¼ë¡œ ì„œë²„ë¡œ ì „ì†¡ë¨)
        const $addressIdInput = $('#addressId');
        const $recipientName = $('#recipientName');
        const $phone = $('#phone');
        const $address = $('#address');
        const $addressName = $('#addressName');

        // ğŸ“Œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
        // í˜ì´ì§€ ë¡œë“œ ì‹œ, ê¸°ë³¸ ì£¼ì†Œê°€ ìˆë‹¤ë©´ ê¸°ì¡´ ì£¼ì†Œ ì •ë³´ë¡œ hidden í•„ë“œë“¤ì„ ì±„ì›Œì¤€ë‹¤.
        if (defaultAddress) {
            // ê¸°ë³¸ ì£¼ì†Œ ë¼ë””ì˜¤ ë²„íŠ¼ì˜ data ê°’ì„ hidden í•„ë“œì— ë¯¸ë¦¬ ì±„ì›Œ ë‘ 
            const $defaultRadio = $('#addr_default');
            $addressIdInput.val($defaultRadio.val()).prop('disabled', false);
            $recipientName.val($defaultRadio.data('recipient-name')).prop('disabled', false);
            $phone.val($defaultRadio.data('phone')).prop('disabled', false);
            $address.val($defaultRadio.data('address')).prop('disabled', false);
            $addressName.val($defaultRadio.data('address-name')).prop('disabled', false);
        } else {
            // ê¸°ë³¸ ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ëª¨ë“  hidden í•„ë“œë¥¼ ë¹„í™œì„±í™” (ì£¼ë¬¸ ë¶ˆê°€ ìƒíƒœ ë˜ëŠ” ì„œë²„ì—ì„œ ì˜¤ë¥˜ ì²˜ë¦¬ í•„ìš”)
            // ì£¼ë¬¸ í˜ì´ì§€ì— ì£¼ì†Œ ì •ë³´ê°€ ì „í˜€ ì—†ìœ¼ë©´ ê²°ì œê°€ ì§„í–‰ë˜ë©´ ì•ˆë˜ë¯€ë¡œ, ì£¼ë¬¸ ì „ì— ì£¼ì†Œë¥¼ ë“±ë¡í•˜ë„ë¡ ìœ ë„í•´ì•¼ í•©ë‹ˆë‹¤.
            $addressIdInput.prop('disabled', true);
            $recipientName.prop('disabled', true);
            $phone.prop('disabled', true);
            $address.prop('disabled', true);
            $addressName.prop('disabled', true);

            // ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŒì„ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ëŠ” ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            if ($('input[name="addressOption"]').length === 0) {
                alert("ì£¼ë¬¸ ê°€ëŠ¥í•œ ë°°ì†¡ì§€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.");
                $('button[type="submit"]').prop('disabled', true).text('ë°°ì†¡ì§€ ì—†ìŒ');
            }
        }


        // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ê°ì§€ (ê¸°ë³¸ ì£¼ì†Œ ë˜ëŠ” ê¸°íƒ€ ì£¼ì†Œ ì„ íƒ ì‹œ)
        $('input[name="addressOption"]').on('change', function() {
            const $selectedRadio = $(this);

            // OrderVOìš© ìˆ¨ê²¨ì§„ í•„ë“œ í™œì„±í™”
            $addressIdInput.prop('disabled', false);
            $recipientName.prop('disabled', false);
            $phone.prop('disabled', false);
            $address.prop('disabled', false);
            $addressName.prop('disabled', false);

            // ì„ íƒëœ ì£¼ì†Œì˜ data ì†ì„±ì—ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì™€ ìˆ¨ê²¨ì§„ OrderVO í•„ë“œì— ì±„ì›€
            $addressIdInput.val($selectedRadio.val());
            $recipientName.val($selectedRadio.data('recipient-name'));
            $phone.val($selectedRadio.data('phone'));
            $address.val($selectedRadio.data('address'));
            $addressName.val($selectedRadio.data('address-name'));
        });

        // í¼ ì œì¶œ ì‹œ ìµœì¢… ê°’ ì„¤ì •
        $('#orderForm').on('submit', function(e) {
            // ìƒˆ ì£¼ì†Œ ì…ë ¥ ë¡œì§ì´ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ,
            // ì´ë¯¸ ì„ íƒëœ ë¼ë””ì˜¤ ë²„íŠ¼ì˜ ì •ë³´ê°€ hidden í•„ë“œì— ë°˜ì˜ë˜ì–´ í™œì„±í™”ëœ ìƒíƒœë¡œ ì „ì†¡ë©ë‹ˆë‹¤.

            // ë§ˆì§€ë§‰ìœ¼ë¡œ, ì£¼ì†Œ IDê°€ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸ (ì£¼ì†Œ ì—†ìœ¼ë©´ ì „ì†¡ ë°©ì§€)
            if ($addressIdInput.val() === '' || $addressIdInput.prop('disabled')) {
                e.preventDefault(); // í¼ ì œì¶œ ì¤‘ì§€
                alert("ìœ íš¨í•œ ë°°ì†¡ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return false;
            }

            return true; // í¼ ì œì¶œ ì§„í–‰
        });
    });
</script>
</body>
</html>