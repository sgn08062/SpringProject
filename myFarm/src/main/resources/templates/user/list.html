<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ ëª©ë¡ - ë†ì¥ì§ì†¡</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/main/main.css}">
    <link rel="stylesheet" th:href="@{/main/index.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/js/auth.js" defer></script>

</head>
<body class="light">

<header>
    <div class="header-container">
        <a th:href="@{/user/list}" class="logo-link">
            <div class="logo"> <img th:src="@{/images/farm-logo.png}" alt="ë†ì¥ì§ì†¡ ë¡œê³ "> <span>ë†ì¥ì§ì†¡</span> </div>
        </a>
        <div class="header-top">
            <h2 th:text="${userName} != null ? ${userName} + 'ë‹˜ ì•ˆë…•í•˜ì„¸ìš”' : 'ê²ŒìŠ¤íŠ¸ë‹˜ ì•ˆë…•í•˜ì„¸ìš”'"></h2>

            <th:block th:if="${isLoggedIn}">
                <a href="/user/address/">ë°°ì†¡ì§€ê´€ë¦¬</a>
                <a th:href="@{/uorder/list}">êµ¬ë§¤ëª©ë¡</a>
                <a th:href="@{/cart}">ì¥ë°”êµ¬ë‹ˆ</a>
            </th:block>

            <th:block th:if="${!isLoggedIn}">
                <a th:href="@{/account/login}" id="loginModalBtn">ë¡œê·¸ì¸</a>
                <a th:href="@{/register}">íšŒì›ê°€ì…</a>
            </th:block>

            <a th:id="logoutBtn" th:if="${isLoggedIn}">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</header>

<div class="main-banner">
    <h1>ì‹ ì„ í•œ ë†ì‚°ë¬¼ ì§ê±°ë˜</h1>
    <p>ë†ë¶€ê°€ ì§ì ‘ í‚¤ìš´ ìœ ê¸°ë† ë†ì‚°ë¬¼ì„ ë§Œë‚˜ë³´ì„¸ìš”</p>
</div>

<div class="search-container">
    <form id="searchForm" class="search-form">
        <input type="text" id="searchKeywordInput" name="searchKeyword" placeholder="ğŸ” ìƒí’ˆ ê²€ìƒ‰..." th:value="${searchKeyword}">
        <select id="sortFieldSelect" name="sortField">
            <option value="regDate" th:selected="${sortField == 'regDate' or sortField == null}">ì „ì²´</option>
            <option value="priceAsc" th:selected="${sortField == 'priceAsc'}">ê°€ê²© ë‚®ì€ìˆœ</option>
        </select>
    </form>
</div>

<div id="productList" th:if="${itemList != null}">
    <div class="crop-item" th:each="item : ${itemList}">

        <a href="javascript:void(0)" th:onclick="|openDetailModal(${item.itemId})|" class="item-image-link">
            <div class="item-image">
                <th:block th:switch="${item.itemId}">
                    <img th:case="1" th:src="@{https://images.unsplash.com/photo-1745791562822-7ac21012bbb2?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080}" th:alt="${item.itemName} + ' ì´ë¯¸ì§€'">
                    <img th:case="2" th:src="@{https://images.unsplash.com/photo-1657411658279-e32af8636eb1?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080}" th:alt="${item.itemName} + ' ì´ë¯¸ì§€'">
                    <img th:case="3" th:src="@{https://images.unsplash.com/photo-1717959159782-98c42b1d4f37?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080}" th:alt="${item.itemName} + ' ì´ë¯¸ì§€'">
                    <img th:case="4" th:src="@{https://images.unsplash.com/photo-1710528184650-fc75ae862c13?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080}" th:alt="${item.itemName} + ' ì´ë¯¸ì§€'">
                    <img th:case="5" th:src="@{https://images.unsplash.com/photo-1730202252661-bd76bd26378f?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080}" th:alt="${item.itemName} + ' ì´ë¯¸ì§€'">
                    <img th:case="*" th:src="@{https://images.unsplash.com/photo-1745791562822-7ac21012bbb2?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080}" th:alt="${item.itemName} + ' ì´ë¯¸ì§€'">
                </th:block>

                <div th:unless="${item.inventoryAmount != null and item.inventoryAmount > 0}" class="sold-out-overlay">SOLD OUT</div>
            </div>
        </a>

        <div class="item-info">
            <div class="flex-item-header">
                <h2 th:text="${item.itemName ?: 'ìƒí’ˆëª…'}">ìƒí’ˆëª…</h2>
                <span class="badge">ìˆ˜í™•ì‹œê¸°</span>
            </div>
            <p class="farmer-name">íŒë§¤ì ì •ë³´</p>
            <p class="price" th:text="|${#numbers.formatDecimal(item.price ?: 0, 0, 'COMMA', 0, 'POINT')}ì› / ê°œ|">ê°€ê²© / ë‹¨ìœ„</p>

            <div class="btn-wrapper">
                <th:block th:if="${item.inventoryAmount != null and item.inventoryAmount > 0}">
                    <form th:action="@{/cart/pushCart}" method="post" class="cart-form-inline">
                        <input type="hidden" name="itemId" th:value="${item.itemId}">
                        <input type="hidden" name="amount" value="1">
                        <button type="submit" class="btn cart">ì£¼ë¬¸í•˜ê¸°</button> </form>
                </th:block>
                <th:block th:unless="${item.inventoryAmount != null and item.inventoryAmount > 0}">
                    <span class="btn" style="background-color: var(--muted); color: var(--muted-foreground); cursor: default; width: 100%;">í’ˆì ˆ</span>
                </th:block>
            </div>
        </div>
    </div>
</div>

<footer class="main-footer">
    <div class="footer-content">
        <div class="footer-section">
            <h3>ë†ì¥ì§ì†¡</h3>
            <p>ì‹ ì„ í•œ ë†ì‚°ë¬¼ì„ ë†ì¥ì—ì„œ ì§ì ‘ ì†Œë¹„ìì—ê²Œ ì „ë‹¬í•˜ëŠ” ì§ê±°ë˜ í”Œë«í¼ì…ë‹ˆë‹¤.</p>
        </div>
        <div class="footer-section">
            <h3>ê³ ê°ì„¼í„°</h3>
            <p>ğŸ“ 1588-1234</p>
            <p>âœ‰ï¸ support@farm.com</p>
        </div>
        <div class="footer-section">
            <a th:href="@{/user/order}">ì£¼ë¬¸ ëª©ë¡</a>
            <a href="#">ì´ìš©ì•½ê´€</a>
            <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        </div>
        <div class="footer-section">
            <h3>íšŒì‚¬ ì •ë³´</h3>
            <p>ğŸ“ ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123</p>
            <p>ëŒ€í‘œì´ì‚¬ : ê¹€ë†ë¶€</p>
        </div>
    </div>
</footer>

<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close login-close">&times;</span>
        <h2>ë¡œê·¸ì¸</h2>
        <form th:action="@{/login}" method="post">
            <label for="loginId">ì•„ì´ë””</label>
            <input type="text" id="loginId" name="loginId" required>

            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password" name="userPw" required> <button type="submit">ë¡œê·¸ì¸</button>
        </form>
        <p style="text-align: center; margin-top: 15px;">
            <a th:href="@{/find-password}" style="color: #007bff;">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a> |
            <a th:href="@{/register}" style="color: #007bff;">íšŒì›ê°€ì…</a> </p>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close detail-close">&times;</span>
        <div id="detailContentContainer">
            <p style="text-align: center;">Loading...</p>
        </div>
    </div>
</div>


<script th:inline="javascript">

    const loginModal = document.getElementById("loginModal");
    const loginBtn = document.getElementById("loginModalBtn");
    const loginClose = document.querySelector("#loginModal .close");

    if(loginBtn) {
        loginBtn.onclick = function(event) {
            event.preventDefault();
            loginModal.style.display = "block";
        }
    }
    if(loginClose) {
        loginClose.onclick = function() {
            loginModal.style.display = "none";
        }
    }

    const detailModal = document.getElementById("detailModal");
    const detailClose = document.querySelector("#detailModal .close");
    const detailContentContainer = document.getElementById("detailContentContainer");

    if (detailClose) {
        detailClose.onclick = function() {
            detailModal.style.display = "none";
            detailContentContainer.innerHTML = '<p style="text-align: center;">Loading...</p>';
        }
    }

    window.onclick = function(event) {
        if (event.target == loginModal) {
            loginModal.style.display = "none";
        }
        if (event.target == detailModal) {
            detailModal.style.display = "none";
            detailContentContainer.innerHTML = '<p style="text-align: center;">Loading...</p>';
        }
    }

    function openDetailModal(itemId) {
        detailModal.style.display = "block";
        detailContentContainer.innerHTML = '<p style="text-align: center;">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

        $.ajax({
            url: /*[[@{/user/detail}]]*/ '/user/detail',
            type: 'GET',
            data: { itemId: itemId },
            success: function(response) {
                let itemImage = '';
                switch(itemId) {
                    case 1: itemImage = 'https://images.unsplash.com/photo-1745791562822-7ac21012bbb2?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080'; break;
                    case 2: itemImage = 'https://images.unsplash.com/photo-1657411658279-e32af8636eb1?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080'; break;
                    case 3: itemImage = 'https://images.unsplash.com/photo-1717959159782-98c42b1d4f37?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080'; break;
                    default: itemImage = 'https://images.unsplash.com/photo-1745791562822-7ac21012bbb2?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080';
                }

                const stock = response.inventoryAmount || 0;
                const isSoldOut = stock <= 0;

                let content = `
                    <img src="${itemImage}" alt="${response.itemName} ì´ë¯¸ì§€" class="detail-item-image">
                    <h2>${response.itemName}</h2>
                    <p class="detail-price">${new Intl.NumberFormat('ko-KR').format(response.price)}ì› / ê°œ</p>
                    <p>ì¬ê³ : ${stock > 0 ? stock + 'ê°œ' : 'í’ˆì ˆ'}</p>
                    <p>íŒë§¤ì: ë†ë¶€ ê¹€ì”¨</p>
                    <hr>
                    <p><strong>ìƒí’ˆ ì„¤ëª…:</strong> ì‹±ì‹±í•˜ê³  ë§›ìˆëŠ” ì œì²  ë†ì‚°ë¬¼ì…ë‹ˆë‹¤. ì§€ê¸ˆ ë°”ë¡œ ë§Œë‚˜ë³´ì„¸ìš”!</p>
                    <div class="btn-wrapper" style="margin-top: 20px;">
                        ${!isSoldOut
                    ? `<form action="/*[[@{/cart/pushCart}]]*/" method="post" class="cart-form-inline">
                                    <input type="hidden" name="itemId" value="${response.itemId}">
                                    <input type="number" name="amount" value="1" min="1" max="${stock}" style="width: 60px; margin-right: 5px;">
                                    <button type="submit" class="btn cart">ì£¼ë¬¸í•˜ê¸°</button> </form>`
                    : `<span class="btn" style="background-color: var(--muted); cursor: default; width: 100%;">í’ˆì ˆ</span>`}
                    </div>
                `;
                detailContentContainer.innerHTML = content;
            },
            error: function(xhr, status, error) {
                detailContentContainer.innerHTML = '<p style="text-align: center; color: red;">ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (' + xhr.status + ')</p>';
            }
        });
    }


    const itemApiUrl = /*[[@{/user/list}]]*/ '/user/list';
    const searchInput = document.getElementById('searchKeywordInput');
    const sortSelect = document.getElementById('sortFieldSelect');
    const productListContainer = document.getElementById('productList');

    function executeSearch() {
        const keyword = searchInput.value.trim();
        const sortField = sortSelect.value;

        const queryParams = new URLSearchParams({
            searchKeyword: keyword,
            sortField: sortField,
            isAjax: true
        });

        fetch(`${itemApiUrl}?${queryParams.toString()}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ê²€ìƒ‰ ìš”ì²­ ì‹¤íŒ¨: ' + response.statusText);
                }
                return response.json();
            })
            .then(items => {
                updateProductList(items);
            })
            .catch(error => {
                productListContainer.innerHTML = '<p class="error-message">ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            });
    }

    function updateProductList(items) {
        let htmlContent = '';

        if (items.length === 0) {
            productListContainer.innerHTML = '<p class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        items.forEach(item => {
            const isSoldOut = item.inventoryAmount == null || item.inventoryAmount <= 0;
            const priceFormatted = new Intl.NumberFormat('ko-KR').format(item.price || 0);

            let itemImage = 'https://images.unsplash.com/photo-1745791562822-7ac21012bbb2?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080';
            switch(item.itemId) {
                case 2: itemImage = 'https://images.unsplash.com/photo-1657411658279-e32af8636eb1?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080'; break;
                case 3: itemImage = 'https://images.unsplash.com/photo-1717959159782-98c42b1d4f37?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080'; break;
                case 4: itemImage = 'https://images.unsplash.com/photo-1710528184650-fc75ae862c13?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080'; break;
                case 5: itemImage = 'https://images.unsplash.com/photo-1730202252661-bd76bd26378f?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&w=1080'; break;
            }

            htmlContent += `
                <div class="crop-item">
                    <a href="javascript:void(0)" onclick="openDetailModal(${item.itemId})" class="item-image-link">
                        <div class="item-image">
                            <img src="${itemImage}" alt="${item.itemName} ì´ë¯¸ì§€">
                            ${!isSoldOut ? '' : '<div class="sold-out-overlay">SOLD OUT</div>'}
                        </div>
                    </a>

                    <div class="item-info">
                        <div class="flex-item-header">
                            <h2>${item.itemName || 'ìƒí’ˆëª…'}</h2>
                            <span class="badge">ìˆ˜í™•ì‹œê¸°</span>
                        </div>
                        <p class="farmer-name">íŒë§¤ì ì •ë³´</p>
                        <p class="price">${priceFormatted}ì› / ê°œ</p>

                        <div class="btn-wrapper">
                            ${!isSoldOut
                ? `<form action="/*[[@{/cart/pushCart}]]*/" method="post" class="cart-form-inline">
                                    <input type="hidden" name="itemId" value="${item.itemId}">
                                    <input type="hidden" name="amount" value="1">
                                    <button type="submit" class="btn cart">ì£¼ë¬¸í•˜ê¸°</button>
                                </form>`
                : `<span class="btn" style="background-color: var(--muted); color: var(--muted-foreground); cursor: default; width: 100%;">í’ˆì ˆ</span>`}
                        </div>
                    </div>
                </div>
            `;
        });

        productListContainer.innerHTML = htmlContent;
    }

    searchInput.addEventListener('keyup', executeSearch);
    sortSelect.addEventListener('change', executeSearch);

</script>

</body>
</html>