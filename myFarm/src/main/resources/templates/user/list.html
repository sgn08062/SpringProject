<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품 목록 - 농장직송</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/main/main.css}">
    <link rel="stylesheet" th:href="@{/main/index.css}">
    <link rel="stylesheet" th:href="@{/main/ai.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/js/auth.js" defer></script>

</head>
<body class="light">

<header th:replace="~{common/BaseLayout :: mainHeader(userName=${userName}, isLoggedIn=${isLoggedIn})}"></header>

<div class="main-banner">
    <h1>신선한 농산물 직거래</h1>
    <p>농부가 직접 키운 유기농 농산물을 만나보세요</p>
</div>

<div class="search-container">
    <form id="searchForm" class="search-form">
        <input type="text" id="searchKeywordInput" name="searchKeyword" placeholder="🔍 상품 검색..." th:value="${searchKeyword}">
        <!--<select id="sortFieldSelect" name="sortField">
            <option value="regDate" th:selected="${sortField == 'regDate' or sortField == null}">전체</option>
            <option value="priceAsc" th:selected="${sortField == 'priceAsc'}">가격 낮은순</option>
        </select>-->
    </form>
</div>

<div id="productList" th:if="${itemList != null}">
    <div class="crop-item" th:each="item : ${itemList}">

        <a href="javascript:void(0)" th:onclick="|openDetailModal(${item.itemId})|" class="item-image-link">
            <div class="item-image">
                <th:block th:with="filteredImages=${item.images.?[imageType == 'MAIN']}">
                    <th:block th:with="mainImage=${#lists.isEmpty(filteredImages) ? null : filteredImages[0]}">
                        <img th:src="${mainImage?.imageUrl != null ? '/upload/' + mainImage.imageUrl : '/img/defaultimg.png'}"
                             th:alt="${item.itemName} + ' 대표 이미지'"
                             onerror="this.src='/images/farm-logo.png'">
                    </th:block>
                </th:block>

                <div th:unless="${item.inventoryAmount != null and item.inventoryAmount > 0}" class="sold-out-overlay">SOLD OUT</div>
            </div>
        </a>

        <div class="item-info">
            <div class="flex-item-header">
                <h2 th:text="${item.itemName ?: '상품명'}">상품명</h2>
                <span class="badge">수확시기</span>
            </div>
            <p class="farmer-name">관리자</p>
            <p class="price" th:text="|${#numbers.formatDecimal(item.price ?: 0, 0, 'COMMA', 0, 'POINT')}원 / 개|">가격 / 단위</p>

            <div class="btn-wrapper">
                <th:block th:if="${item.inventoryAmount != null and item.inventoryAmount > 0}">
                    <form th:action="@{/cart/pushCart}" method="post" class="cart-form-inline">
                        <input type="hidden" name="itemId" th:value="${item.itemId}">
                        <input type="hidden" name="amount" value="1">
                        <button type="submit" class="btn cart">주문하기</button> </form>
                </th:block>
                <th:block th:unless="${item.inventoryAmount != null and item.inventoryAmount > 0}">
                    <span class="btn" style="background-color: var(--muted); color: var(--muted-foreground); cursor: default; width: 100%;">품절</span>
                </th:block>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{common/BaseLayout :: mainFooter}"></footer>

<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close login-close">&times;</span>
        <h2>로그인</h2>
        <form th:action="@{/login}" method="post">
            <label for="loginId">아이디</label>
            <input type="text" id="loginId" name="loginId" required>

            <label for="password">비밀번호</label>
            <input type="password" id="password" name="userPw" required> <button type="submit">로그인</button>
        </form>
        <p style="text-align: center; margin-top: 15px;">
            <a th:href="@{/find-password}" style="color: #007bff;">비밀번호 찾기</a> |
            <a th:href="@{/register}" style="color: #007bff;">회원가입</a> </p>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close detail-close">&times;</span>
        <div id="detailContentContainer">
            <p style="text-align: center;">Loading...</p>
        </div>
    </div>
</div>

<div id="aiChatBtn" onclick="toggleChat()">
    <img th:src="@{/img/bot_icon.png}" alt="AI" onerror="this.outerHTML='<span style=\'color:white;font-weight:bold;\'>AI</span>'">
</div>

<div id="chatContainer">
    <div class="chat-header">
        <span>🤖 농장직송 AI 도우미</span>
        <span class="chat-close" onclick="toggleChat()">&times;</span>
    </div>
    <div id="chatMessages">
        <div class="message bot">
            안녕하세요! 농작물의 **재고**나 **수확시기**가 궁금하시면 물어봐주세요.<br>
            예) "수박 몇 개 남았어?", "오이 수확시기는?"
        </div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="질문을 입력하세요..." onkeypress="handleEnter(event)">
        <button id="sendBtn" onclick="sendMessage()">전송</button>
    </div>
</div>

<script th:src="@{/js/main.js}"></script>
</body>
</html>