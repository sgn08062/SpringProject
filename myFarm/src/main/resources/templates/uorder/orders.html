<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ë¬¸/ê²°ì œ</title>
    <link rel="stylesheet" th:href="@{/main/main.css}">
    <link rel="stylesheet" th:href="@{/css/order.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; text-align: center; }
        th, td { border: 1px solid #ddd; padding: 10px; }
        th { background-color: #f2f2f2; }
        td:nth-child(2), td:nth-child(4) { text-align: right; }
        h2 { margin-top: 20px; }
        #finalTotal { font-size: 1.5em; color: #dc3545; font-weight: bold; }
        button[type="submit"] { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; margin-top: 20px; }

        .address-option label { display: block; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; cursor: pointer; border-radius: 4px; }
        .address-option input[type="radio"]:checked + label { border-color: #28a745; background-color: #e9ffe9; font-weight: bold; }
        .address-detail-text { margin-left: 20px; font-size: 0.9em; color: #555; }

        .stored-address-list { border: 1px solid #eee; padding: 10px; margin-top: 10px; max-height: 250px; overflow-y: auto; }
        .stored-address-list .address-option label { border: none; border-bottom: 1px dashed #ddd; margin-bottom: 0; }
        .stored-address-list .address-option:last-child label { border-bottom: none; }

        #newAddressFields { border: 1px dashed #aaa; padding: 15px; margin-top: 10px; border-radius: 4px; display: none; }
        #newAddressFields input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; }
    </style>
</head>
<body>
<h1>ğŸ›’ ì£¼ë¬¸/ê²°ì œ</h1>

<div th:if="${successMessage}" class="message success" th:text="${successMessage}"></div>
<div th:if="${errorMessage}" class="message error" th:text="${errorMessage}"></div>

<form th:action="@{/uorder/place}" method="post" id="orderForm">

    <input type="hidden" name="addressId" id="addressId" th:value="${defaultAddress != null ? defaultAddress.addressId : ''}">
    <input type="hidden" name="ordRecipientName" id="recipientName" th:value="${defaultAddress != null ? defaultAddress.recipientName : ''}">
    <input type="hidden" name="phone" id="phone" th:value="${defaultAddress != null ? defaultAddress.recipientPhone : ''}">
    <input type="hidden" name="address" id="address" th:value="${defaultAddress != null ? defaultAddress.address : ''}">
    <input type="hidden" name="addressName" id="addressName" th:value="${defaultAddress != null ? defaultAddress.addressName : ''}">

    <h2>ë°°ì†¡ ì •ë³´</h2>

    <div class="address-options">

        <div th:if="${defaultAddress != null or (otherAddresses != null and otherAddresses.size() > 0)}">
            <p style="margin-top: 15px; font-weight: bold;">ğŸ“¦ ì €ì¥ëœ ë°°ì†¡ì§€ ì •ë³´</p>
            <div class="stored-address-list">

                <div th:if="${defaultAddress != null}" class="address-option">
                    <input type="radio" id="addr_default" name="addressOption" th:value="${defaultAddress.addressId}"
                           th:data-recipient-name="${defaultAddress.recipientName}" th:data-phone="${defaultAddress.recipientPhone}"
                           th:data-address="${defaultAddress.address}" th:data-address-name="${defaultAddress.addressName}" th:checked="true">
                    <label for="addr_default">
                        **[ê¸°ë³¸]** [[${defaultAddress.addressName}]]
                        <span class="address-detail-text">([[${defaultAddress.address}]])</span>
                        <p style="font-size: 0.8em; margin: 5px 0 0 0;">ìˆ˜ë ¹ì¸: [[${defaultAddress.recipientName}]] / [[${defaultAddress.recipientPhone}]]</p>
                    </label>
                </div>

                <div th:each="addr : ${otherAddresses}" class="address-option">
                    <input type="radio" th:id="'addr_' + ${addr.addressId}" name="addressOption" th:value="${addr.addressId}"
                           th:data-recipient-name="${addr.recipientName}" th:data-phone="${addr.recipientPhone}"
                           th:data-address="${addr.address}" th:data-address-name="${addr.addressName}"
                           th:checked="${defaultAddress == null and otherAddresses.indexOf(addr) == 0 ? true : false}">
                    <label th:for="'addr_' + ${addr.addressId}">
                        [[${addr.addressName}]]
                        <span class="address-detail-text">([[${addr.address}]])</span>
                        <p style="font-size: 0.8em; margin: 5px 0 0 0;">ìˆ˜ë ¹ì¸: [[${addr.recipientName}]] / [[${addr.recipientPhone}]]</p>
                    </label>
                </div>

            </div>
        </div>

        <div class="address-option" th:style="${defaultAddress == null and (otherAddresses == null or otherAddresses.size() == 0) ? 'margin-top: 5px; border: 2px solid #dc3545;' : 'margin-top: 15px;'}">
            <input type="radio" id="addr_new" name="addressOption" value="0"
                   th:checked="${defaultAddress == null and (otherAddresses == null or otherAddresses.size() == 0) ? true : false}">
            <label for="addr_new">
                **â• ì‹ ê·œ ë°°ì†¡ì§€ ì§ì ‘ ì…ë ¥**
            </label>
        </div>

        <div id="newAddressFields" th:style="${defaultAddress == null and (otherAddresses == null or otherAddresses.size() == 0) ? 'display: block;' : 'display: none;'}">
            <label for="new_addressName">ë°°ì†¡ì§€ëª…:</label>
            <input type="text" id="new_addressName" placeholder="ì˜ˆ: ìš°ë¦¬ì§‘, íšŒì‚¬" value="ì‹ ê·œ ë°°ì†¡ì§€">

            <label for="new_recipientName">ìˆ˜ë ¹ì¸:</label>
            <input type="text" id="new_recipientName" placeholder="ìˆ˜ë ¹ì¸ ì´ë¦„">

            <label for="new_phone">ì—°ë½ì²˜:</label>
            <input type="text" id="new_phone" placeholder="ì˜ˆ: 010-1234-5678">

            <label for="new_address">ì£¼ì†Œ:</label>
            <input type="text" id="new_address" placeholder="ë°°ì†¡ì§€ ì£¼ì†Œ (ìƒì„¸ ì£¼ì†Œ í¬í•¨)">
        </div>

    </div>

    <hr>

    <h2>ì£¼ë¬¸ ìƒí’ˆ ëª©ë¡</h2>
    <table>
        <thead>
        <tr>
            <th>ìƒí’ˆëª…</th>
            <th>ë‹¨ê°€</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>í•©ê³„</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${checkoutItems}">
            <input type="hidden" th:name="'itemAmount_' + ${item.itemId}" th:value="${item.orderAmount}">
            <input type="hidden" name="selectedItems" th:value="${item.itemId}">

            <td th:text="${item.itemName}">ìƒí’ˆëª…</td>
            <td style="text-align: right;" th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + 'ì›'">ë‹¨ê°€</td>
            <td th:text="${item.orderAmount}">ìˆ˜ëŸ‰</td>
            <td style="text-align: right;" th:with="total=${item.orderAmount * item.price}" th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + 'ì›'">í•©ê³„</td>
        </tr>
        </tbody>
    </table>
    <hr>

    <h2>ìµœì¢… ê²°ì œ ê¸ˆì•¡: <span id="finalTotal" th:with="displayPrice=${totalPrice != null ? totalPrice : 0}" th:text="${#numbers.formatDecimal(displayPrice, 0, 'COMMA', 0, 'POINT')} + 'ì›'">ì´ ê°€ê²©</span></h2>

    <button type="submit">ê²°ì œí•˜ê¸° (ì£¼ë¬¸ í™•ì •)</button>

</form>

<script th:inline="javascript">
    const defaultAddress = /*[[${defaultAddress}]]*/ null;
    const otherAddresses = /*[[${otherAddresses}]]*/ [];

    $(document).ready(function() {

        const $addressIdInput = $('#addressId');
        // name="ordRecipientName"ì´ì§€ë§Œ idëŠ” recipientNameì„ ì‚¬ìš©
        const $recipientName = $('#recipientName');
        const $phone = $('#phone');
        const $address = $('#address');
        const $addressName = $('#addressName');

        const $newAddressFields = $('#newAddressFields');
        const $new_addressName = $('#new_addressName');
        const $new_recipientName = $('#new_recipientName');
        const $new_phone = $('#new_phone');
        const $new_address = $('#new_address');

        // const $submitBtn = $('button[type="submit"]'); // ì‚¬ìš©ë˜ì§€ ì•Šì•„ ì£¼ì„ ì²˜ë¦¬

        function fillOrderFields(data) {
            $addressIdInput.val(data.addressId);
            $recipientName.val(data.recipientName);
            $phone.val(data.phone);
            $address.val(data.address);
            $addressName.val(data.addressName);

            // Hidden Fieldì˜ disabled ì²˜ë¦¬ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë¶ˆí•„ìš”í•˜ë¯€ë¡œ ì œê±°
        }

        function fillOrderFieldsFromNewInputs() {
            fillOrderFields({
                addressId: 0,
                recipientName: $new_recipientName.val(),
                phone: $new_phone.val(),
                address: $new_address.val(),
                addressName: $new_addressName.val()
            });
        }


        const hasStoredAddresses = defaultAddress || (otherAddresses && otherAddresses.length > 0);

        // í˜ì´ì§€ ë¡œë”© ì‹œ ì´ˆê¸° ì£¼ì†Œ ì„ íƒ/ì…ë ¥ í•„ë“œ ì„¤ì •
        if (hasStoredAddresses) {
            const $checkedRadio = $('input[name="addressOption"]:checked');
            if ($checkedRadio.length) {
                fillOrderFields({
                    addressId: $checkedRadio.val(),
                    recipientName: $checkedRadio.data('recipient-name'),
                    phone: $checkedRadio.data('phone'),
                    address: $checkedRadio.data('address'),
                    addressName: $checkedRadio.data('address-name')
                });
            }
        } else {
            // ì €ì¥ëœ ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ì‹ ê·œ ì…ë ¥ ê¸°ë³¸ ì„ íƒ ë° í•„ë“œ ì±„ìš°ê¸°
            $('#addr_new').prop('checked', true);
            fillOrderFieldsFromNewInputs();
            $newAddressFields.slideDown();
        }

        // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ì‹œ ì²˜ë¦¬
        $('input[name="addressOption"]').on('change', function() {
            const $selectedRadio = $(this);
            const addressId = $selectedRadio.val();

            if (addressId === '0') {
                $newAddressFields.slideDown();
                fillOrderFieldsFromNewInputs(); // ì‹ ê·œ í•„ë“œì˜ ê°’ìœ¼ë¡œ OrderVO Hidden Fields ì±„ìš°ê¸°
            }
            else {
                $newAddressFields.slideUp();

                fillOrderFields({ // ì €ì¥ëœ ì£¼ì†Œì˜ data-* ì†ì„± ê°’ìœ¼ë¡œ OrderVO Hidden Fields ì±„ìš°ê¸°
                    addressId: addressId,
                    recipientName: $selectedRadio.data('recipient-name'),
                    phone: $selectedRadio.data('phone'),
                    address: $selectedRadio.data('address'),
                    addressName: $selectedRadio.data('address-name')
                });
            }
        });

        // ì‹ ê·œ ì£¼ì†Œ ì…ë ¥ í•„ë“œ ê°’ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ OrderVO Hidden Fields ì—…ë°ì´íŠ¸
        $newAddressFields.find('input').on('input', function() {
            if ($('#addr_new').prop('checked')) {
                fillOrderFieldsFromNewInputs();
            }
        });


        $('#orderForm').on('submit', function(e) {

            const selectedAddressId = $addressIdInput.val();

            if (selectedAddressId === '') {
                e.preventDefault();
                alert("ìœ íš¨í•œ ë°°ì†¡ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return false;
            }

            if (selectedAddressId === '0') {
                // ì‹ ê·œ ì£¼ì†Œ ì…ë ¥ í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬
                if ($new_recipientName.val() === '' || $new_phone.val() === '' || $new_address.val() === '' || $new_addressName.val() === '') {
                    e.preventDefault();
                    alert("ì‹ ê·œ ë°°ì†¡ì§€ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return false;
                }

                // ì‹ ê·œ ì£¼ì†Œì¼ ê²½ìš° ìµœì¢…ì ìœ¼ë¡œ OrderVO í•„ë“œ ì—…ë°ì´íŠ¸ (í˜¹ì‹œ ëª¨ë¥¼ ë§ˆì§€ë§‰ í™•ì¸)
                fillOrderFieldsFromNewInputs();
            }

            return true;
        });
    });
</script>
</body>
</html>