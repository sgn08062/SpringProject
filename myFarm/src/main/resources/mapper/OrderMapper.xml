<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/schema/mybatis-3-mapper.dtd">

<mapper namespace="com.example.myFarm.uorder.OrderMapper">

    <resultMap id="OrderWithItems" type="OrderVO">
        <id property="orderId" column="ORDER_ID" />
        <result property="status" column="STATUS" />
        <result property="address" column="ADDRESS" />
        <result property="phone" column="PHONE" />
        <result property="userId" column="USER_ID" />
        <result property="orderDate" column="ORDER_DATE" />
        <result property="totalAmount" column="TOTAL_AMOUNT" />
        <result property="representativeItemName" column="REP_ITEM_NAME" />
        <result property="ordRecipientName" column="ORD_RECIPIENT_NAME" />

        <collection property="orderItems" ofType="ItemVO">
            <id property="itemId" column="OA_ITEM_ID" />
            <result property="orderAmount" column="OA_AMOUNT" />
            <result property="price" column="OA_UNIT_PRICE" />
            <result property="itemName" column="S_ITEM_NAME" />
        </collection>
    </resultMap>

    <insert id="insertOrder" parameterType="OrderVO" useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO ORDERS ( STATUS, ADDRESS, PHONE, USER_ID, ORD_RECIPIENT_NAME )
        VALUES ( #{status}, #{address}, #{phone}, #{userId}, #{ordRecipientName} )
    </insert>

    <insert id="insertOrderAmount">
        INSERT INTO ORDER_AMOUNT (ORDER_ID, ITEM_ID, AMOUNT, UNIT_PRICE)
        VALUES (#{param1}, #{param2}, #{param3}, #{param4})
    </insert>

    <update id="updateInventoryStock">
        UPDATE INVENTORY i
        JOIN SHOP s ON i.STOR_ID = s.STOR_ID
        SET i.AMOUNT = i.AMOUNT - #{param2}
        WHERE s.ITEM_ID = #{param1}
    </update>

    <update id="updateItemStatusToSoldOut">
        UPDATE SHOP
        SET STATUS = 0
        WHERE ITEM_ID = #{param1}
    </update>

    <select id="getItemForOrder" resultType="ItemVO">
        SELECT
        s.ITEM_ID AS itemId,
        s.ITEM_NAME AS itemName,
        s.PRICE AS price,
        s.STATUS AS itemStatus,
        i.AMOUNT AS stockAmount
        FROM SHOP s
        JOIN INVENTORY i ON s.STOR_ID = i.STOR_ID
        WHERE s.ITEM_ID = #{itemId}
    </select>

    <select id="selectOrderList" parameterType="int" resultMap="OrderWithItems">
        SELECT
        DISTINCT
        o.ORDER_ID,
        o.STATUS,
        o.ADDRESS,
        o.PHONE,
        o.USER_ID,
        o.ORDER_DATE,
        o.TOTAL_AMOUNT,
        o.REP_ITEM_NAME,
        o.ORD_RECIPIENT_NAME,
        oa.ITEM_ID AS OA_ITEM_ID,
        oa.AMOUNT AS OA_AMOUNT,
        oa.UNIT_PRICE AS OA_UNIT_PRICE,
        s.ITEM_NAME AS S_ITEM_NAME
        FROM ORDERS o
        INNER JOIN ORDER_AMOUNT oa ON o.ORDER_ID = oa.ORDER_ID
        INNER JOIN SHOP s ON oa.ITEM_ID = s.ITEM_ID
        WHERE o.USER_ID = #{userId}
        ORDER BY o.ORDER_ID DESC, oa.ITEM_ID ASC, o.order_date desc
    </select>

    <select id="selectOrderDetail" resultMap="OrderWithItems">
        SELECT
        o.ORDER_ID,
        o.STATUS,
        o.ORDER_DATE,
        o.ADDRESS,
        o.PHONE,
        o.USER_ID,
        o.TOTAL_AMOUNT,
        o.REP_ITEM_NAME,
        o.ORD_RECIPIENT_NAME,
        oa.ITEM_ID AS OA_ITEM_ID,
        oa.AMOUNT AS OA_AMOUNT,
        oa.UNIT_PRICE AS OA_UNIT_PRICE,
        s.ITEM_NAME AS S_ITEM_NAME
        FROM ORDERS o
        INNER JOIN ORDER_AMOUNT oa ON o.ORDER_ID = oa.ORDER_ID
        INNER JOIN SHOP s ON oa.ITEM_ID = s.ITEM_ID
        WHERE o.ORDER_ID = #{param1} AND o.USER_ID = #{param2}
        ORDER BY oa.ITEM_ID ASC
    </select>

    <select id="selectOrderItems" resultType="ItemVO">
        SELECT
        OA.ITEM_ID AS itemId,
        OA.AMOUNT AS orderAmount,
        OA.UNIT_PRICE AS price,
        S.ITEM_NAME AS itemName
        FROM ORDER_AMOUNT OA
        JOIN SHOP S ON OA.ITEM_ID = S.ITEM_ID
        WHERE OA.ORDER_ID = #{orderId}
    </select>

    <update id="cancelOrder">
        UPDATE ORDERS
        SET STATUS = '주문 취소'
        WHERE ORDER_ID = #{param1} AND USER_ID = #{param2}
        AND STATUS != '주문 취소'
    </update>

    <update id="updateOrderSummary" parameterType="OrderVO">
        UPDATE ORDERS
        SET TOTAL_AMOUNT = #{totalAmount},
        REP_ITEM_NAME = #{representativeItemName},
        STATUS = '결제 완료'
        WHERE ORDER_ID = #{orderId}
    </update>

    <update id="returnInventoryStock">
        UPDATE INVENTORY i
        JOIN SHOP s ON i.STOR_ID = s.STOR_ID
        JOIN ORDER_AMOUNT oa ON s.ITEM_ID = oa.ITEM_ID
        SET i.AMOUNT = i.AMOUNT + oa.AMOUNT
        WHERE oa.ORDER_ID = #{orderId}
    </update>



    <select id="getTotalOrderCount" resultType="int">
        SELECT
        COUNT(ORDER_ID)
        FROM ORDERS
        WHERE USER_ID = #{userId}
        <if test="cri.startDate != null and cri.startDate != ''">
            AND ORDER_DATE <![CDATA[ >= ]]> DATE(#{cri.startDate})
        </if>
        <if test="cri.endDate != null and cri.endDate != ''">
            AND ORDER_DATE <![CDATA[ <= ]]> DATE_ADD(DATE(#{cri.endDate}), INTERVAL 1 DAY)
        </if>
    </select>

    <select id="selectOrderListWithPaging" resultMap="OrderWithItems">
        SELECT
        o.ORDER_ID,
        o.STATUS,
        o.ADDRESS,
        o.PHONE,
        o.USER_ID,
        o.ORDER_DATE,
        o.TOTAL_AMOUNT,
        o.REP_ITEM_NAME,
        o.ORD_RECIPIENT_NAME
        FROM ORDERS o
        WHERE o.USER_ID = #{userId}
        <if test="cri.startDate != null and cri.startDate != ''">
            AND o.ORDER_DATE <![CDATA[ >= ]]> DATE(#{cri.startDate})
        </if>
        <if test="cri.endDate != null and cri.endDate != ''">
            AND o.ORDER_DATE <![CDATA[ <= ]]> DATE_ADD(DATE(#{cri.endDate}), INTERVAL 1 DAY)
        </if>
        ORDER BY o.order_date desc, o.ORDER_ID DESC
        LIMIT #{cri.amount} OFFSET #{cri.offset}
    </select>


    <insert id="insertDummyOrder" parameterType="OrderVO" useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO ORDERS ( STATUS, ADDRESS, PHONE, USER_ID, ORD_RECIPIENT_NAME, ORDER_DATE )
        VALUES ( #{status}, #{address}, #{phone}, #{userId}, #{ordRecipientName}, #{orderDate} )
    </insert>
</mapper>